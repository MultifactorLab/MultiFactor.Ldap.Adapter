[![Лицензия](https://img.shields.io/badge/license-view-orange)](LICENSE.ru.md)

# MultiFactor.Ldap.Adapter

_Also available in other languages: [English](README.md)_

**MultiFactor Ldap Adapter** &mdash; программный компонент, LDAP proxy сервер для Windows. Используется для двухфакторной аутентификации пользователей в приложениях с LDAP аутентификацией.

Компонент является частью гибридного 2FA решения сервиса <a href="https://multifactor.ru/" target="_blank">MultiFactor</a>. Компонент доступен вместе с исходным кодом, распространяется бесплатно.

* <a href="https://github.com/MultifactorLab/MultiFactor.Ldap.Adapter" target="_blank">Исходный код</a>
* <a href="https://github.com/MultifactorLab/MultiFactor.Ldap.Adapter/releases" target="_blank">Сборка</a>

Linux-версия компонента доступна в репозитории <a href="https://github.com/MultifactorLab/multifactor-ldap-adapter" target="_blank">multifactor-ldap-adapter</a>.

Дополнительные инструкции по интеграции 2FA в инфраструктуру доступны в <a href="https://multifactor.ru/docs/ldap-adapter/windows/" target="_blank">документации</a>.

## Содержание

- [Общие сведения](#общие-сведения)
  - [Функции компонента](#функции-компонента)
  - [Сценарии использования](#сценарии-использования)
- [Требования для установки компонента](#требования-для-установки-компонента)
- [Конфигурация](#конфигурация)
  - [Общие параметры](#общие-параметры)
- [Запуск компонента](#запуск-компонента)
- [Журналы](#журналы)
  - [Syslog](#syslog)
- [Сертификат для TLS шифрования](#сертификат-для-tls-шифрования)
- [Лицензия](#лицензия)

## Общие сведения

### Функции компонента

Ключевые функции:

- проксирование сетевого трафика по протоколу LDAP;
- поиск запросов на аутентификацию и подтверждение вторым фактором на телефоне пользователя.

Основные возможности:

- работа по протоколам LDAP и LDAPS (шифрованный TLS канал);
- перехват запросов на аутентификацию, использующих механизмы Simple, Digital, NTLM;
- пропуск запросов от сервисных учетных записей (Bind DN) без второго фактора;
- запись журналов в Syslog сервер или SIEM систему.

### Сценарии использования

С помощью компонента можно реализовать следующие сценарии:

* Добавить второй фактор аутентификации в приложения, подключенные к Active Directory или другим LDAP каталогам;
* Включить шифрование трафика для приложений, которые не поддерживают подключение по TLS протоколу.

## Требования для установки компонента

- Компонент устанавливается на любой Windows сервер начиная с версии 2008 R2;
- Минимальные требования для сервера: 2 CPU, 4 GB RAM, 40 GB HDD (обеспечивают работу ОС и адаптера для 100 одновременных подключений &mdash; примерно 1500 пользователей);
- На сервере должны быть открыты TCP порты 389 (LDAP) и 636 (LDAPS) для приема запросов от клиентов;
- Серверу с установленным компонентом необходим доступ к хосту api.multifactor.ru по TCP порту 443 (TLS) напрямую или через HTTP proxy;
- Для взаимодействия с Active Directory, компоненту нужен доступ к серверу домена по TCP порту 389 (LDAP) или 636 (LDAPS);
- Для записи журналов в Syslog, необходим доступ к Syslog серверу.
> Для Windows Server версии младше 2016 необходимо установить <a href="https://www.microsoft.com/en-US/download/details.aspx?id=53344" target="_blank">Microsoft .NET Framework 4.6.2</a>.

## Конфигурация

Параметры работы компонента хранятся в файле ```MultiFactor.Ldap.Adapter.exe.config``` в формате XML.

### Общие параметры
```xml
<!-- Адрес и порт (TCP) по которому адаптер будет принимать запросы по протоколу LDAP -->
<!-- Если указать адрес 0.0.0.0, то адаптер будет слушать все сетевые интерфейсы-->
<add key="adapter-ldap-endpoint" value="0.0.0.0:389"/>

<!-- Адрес и порт (TCP) по которому адаптер будет принимать запросы по зашифрованному протоколу LDAPS -->
<!-- Если указать адрес 0.0.0.0, то адаптер будет слушать все сетевые интерфейсы-->
<add key="adapter-ldaps-endpoint" value="0.0.0.0:636"/>

<!-- Адрес или название домена Active Directory, а также схема подключения ldap или ldaps -->
<add key="ldap-server" value="ldaps://domain.local"/>

<!-- Список сервисных учетных записей, которым не требуется второй фактор, перечисленные через точку с запятой -->
<add key="ldap-service-accounts" value="CN=Service Acc,OU=Users,DC=domain,DC=local"/>


<!--Адрес API Мультифактора -->
<add key="multifactor-api-url" value="https://api.multifactor.ru"/>
<!--Таймаут запросов в API Мультифактора, минимальное значение 65 секунд -->
<add key="multifactor-api-timeout" value="00:01:05"/>
<!-- Параметр NAS-Identifier для подключения к API Мультифактора - из личного кабинета -->
<add key="multifactor-nas-identifier" value=""/>
<!-- Параметр Shared Secret для подключения к API Мультифактора - из личного кабинета -->
<add key="multifactor-shared-secret" value=""/>

<!--Доступ к API Мультифактора через HTTP прокси (опционально)-->
<!--add key="multifactor-api-proxy" value="http://proxy:3128"/-->

<!-- Уровень логирования: 'Debug', 'Info', 'Warn', 'Error' -->
<add key="logging-level" value="Debug"/>
<!--certificate password leave empty or null for certificate without password-->
<!--<add key="certificate-password" value="XXXXXX"/>-->
```

## Запуск компонента

Компонент может работать в консольном режиме или в качестве службы Windows. Для запуска в консольном режиме достаточно запустить приложение.

Для установки в качестве Windows Service выполните команду с ключом ```/i``` от имени Администратора
```shell
MultiFactor.Ldap.Adapter.exe /i
```
Компонент устанавливается в режиме автоматического запуска от имени ```Network Service```.

Для удаления Windows Service выполните команду с ключом ```/u``` от имени Администратора
```shell
MultiFactor.Ldap.Adapter.exe /u
```

## Журналы

Журналы работы компонента находятся в папке ```Logs```. Если их нет, удостоверьтесь, что папка доступна для записи пользователю ```Network Service```.

### Syslog

Для записи журналов в Syslog сервер или SIEM систему, добавьте в конфигурацию следующие параметры:

```xml
<!--адрес и порт сервера, протокол может быть udp или tcp-->
<add key="syslog-server" value="udp://syslog-server:514"/>
<!--формат журнала: RFC3164 или RFC5424-->
<add key="syslog-format" value="RFC5424"/>
<!--категория: User, Auth, Auth2, Local0 .. Local7-->
<add key="syslog-facility" value="Auth"/>
<!--название приложения (tag)-->
<add key="syslog-app-name" value="multifactor-ldap"/>
```

## Сертификат для TLS шифрования

Если включена схема LDAPS, адаптер при первом запуске создаст самоподписанный SSL сертификат и сохранит его в папке Tls в формате pfx без пароля.
Этот сертификат будет использоваться для аутентификации сервера и шифрования трафика. Вы можете заменить его на ваш сертификат при необходимости.

## Лицензия

Обратите внимание на [лицензию](LICENSE.ru.md). Она не дает вам право вносить изменения в исходный код Компонента и создавать производные продукты на его основе. Исходный код предоставляется в ознакомительных целях.
